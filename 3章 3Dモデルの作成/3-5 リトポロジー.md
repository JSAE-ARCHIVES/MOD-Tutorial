# リトポロジーとは？
モデル形状を維持したままポリゴン数を減らしてメッシュを再構築することをリトポロジーといいます。  
CADからエクスポートしたメッシュデータは細かく（数百万△ポリゴン）重たいデータですので、Assetto Corsaで動かすために3Dモデルを約30万△ポリゴン以内に収める必要があります。  
[配布中のNK16 MOD](https://github.com/JSAE-ARCHIVES/FSAEJ-simulator/tree/main/NK16_ICV)では完全手動でリトポロジーを行いました（blenderで一からモデリングしたに等しい）。3DCGのテクニックが要求されることに加えて非常に時間がかかる（約2か月）ので、リトポロジーの自動化ツール（Quad Remesher）も併用して少しでも手間を減らせるようにしましょう。

## リトポロジーのコツ  
よく見える場所（ドライバー視点のコクピット周り，フロントの足回り等）はポリゴン数を割いてよい  
見えにくい場所でとことんポリゴン数を削減する．  
穴はポリゴン数を増やす原因となるのであけない(よく見える部分は空ける)  
## 作業1　位置合わせ
インポートした車両がblender原点にない場合
`G`>`X`、`Y`、`Z`で位置を合わせる。(目分量)  
`オブジェクト`>`適用`>`全トランスフォーム`でオブジェクトの座標が3D空間の原点にリセットされる。

リトポロジー済の`collection`を作りコレクションを非表示にしておく．
オブジェクトを選択して`M`でコレクションを移動できるので，リトポロジーが終わったものから順にリトポロジー済みのコレクションに移動させていくと作業の進捗が分かりやすい．

## 作業2 オブジェクトの分割、削除
インポートしたモデルはすべてのパーツが一つのオブジェクトにまとまっています。一つのオブジェクトに含まれる頂点数が多すぎると編集モードに移行した際に非常にPCの動作が遅くなります。そこでリトポロジーの前段階としてオブジェクトを分けていく作業を行う必要があります。

オブジェクトモードでモデルを選択した状態で`Tab`でエディットモードにする（頂点数が多いとここで急に重たくなる）
`L`でひとつながりになったメッシュを選択し、`P`>`選択`で別オブジェクトとして切り離していく。  
左右で同じパーツがあるものはリトポロジー後にミラーで複製するので、片方削除する。  
これを繰り返す。

## 作業3　リトポロジー
分割したパーツをローポリゴンのモデルに置き換えていきます。[QuadRemesher](https://github.com/JSAE-ARCHIVES/MOD-Tutorial/blob/main/3%E7%AB%A0%203D%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90/%E3%81%8A%E3%81%BE%E3%81%91%20%E3%83%AA%E3%83%88%E3%83%9D%E3%83%AD%E3%82%B8%E3%83%BC%E6%94%AF%E6%8F%B4%E3%82%A2%E3%83%89%E3%82%AA%E3%83%B3.md)を使用することで大幅に時間短縮が見込めると思ったのですが、思い通りにいかないことや、逆にポリゴン数を増やしてしまうことがあったので、手動でのリトポロジーがメインになります。

### カーブオブジェクトを使ったスペースフレームのモデリング
CADデータは細かすぎる&厚みがある分頂点数が2倍のでパイプをローポリモデルで置き換えることで大幅なポリゴン削減になります。  
インポートしたCADデータを参考にblenderで新しくモデリングします。  
#### カーブオブジェクト
パイプ状のパーツを曲げたりするのに便利．メッシュではないので最後にメッシュ化して使います。
`Shift+C`で3Dカーソルを原点にリセットし`Shift+A`で`カーブ>パス`を追加
オブジェクトデータプロパティの設定
プレビュー解像度Uはパイプの長さ方向の解像度を決める．1~3推奨．（大きすぎるとパイプが曲がっていない部分にも分割が入って頂点数が増えてしまう．）
`ジオメトリ>ベベル>深度`でパイプ太さ，`解像度`でパイプ断面の滑らかさを決める．
解像度は2（8角形）程度でよい．（スムーズシェードにするのでカクカクは目立たなくなる）
モディファイアタブを開きミラーモディファイアを追加．
`Tab`で編集モードに入りメッシュと同様に押し出し等を用いてフレームの形を作る．
同じ太さのパイプは1オブジェクトにまとめる．太さの違うパイプを追加したい場合は別のカーブオブジェクトを追加して深度を調節する．
角パイプを作りたい場合，ベベル解像度を0にすればよい．初期状態ではひし形のようになっているが、通常の回転（R）では直せない．この場合はカーブオブジェクトを捩る`Ctrl+T>45`で45°捩ると良い．
フレームの形が出来上がったらカーブオブジェクトを複製しておく（メッシュに変換した後のパイプ編集は困難なのでミスが発覚した際に戻って作業が出来るように）複製したオブジェクトを選択し，`オブジェクト>変換>メッシュ`でカーブをメッシュ化。

### 頂点の結合による頂点削減
アップライト等の削り出しパーツの頂点削減に有効です。
編集モードで削減したい部分の頂点（または全選択）を選択し`M（マージ）>距離で`を選ぶと指定した距離以内にある頂点を結合することができる．
左下に出てくるパネルの`結合距離`の数字を変えることで結合する頂点の距離を調整することができる．形状のニュアンスを損なわない程度に数字を大きくすることで数千もの頂点を結合，削減することができる．
但し，パイプやカウル等の薄板上の物は形状の解像度よりも板の厚さ方向の方が頂点同士の距離が短いため，板の厚さ方向に頂点が結合される．その際にぼこぼこになってしまうので板状パーツにはこの方法は向かない．  

### カウル等
自分で新たにモデリングする必要がある．
1. `Shift+A`で作りたい形状に近い基本形状を選ぶ
`E`（[押し出し](https://blender-cg.net/extrude/)）、`F`([面張り](https://blender-cg.net/make-edge-face/))、`Ctrl+R`（[ループカット](https://blender-cg.net/loop-subdivide/)），`Ctrl+B`（[ベベル](https://blender-cg.net/bevel/)）、ブーリアンモディファイア　（押し出しカットのような操作ができる）等の基本的なコマンドを用いて大まかな形を作る  
1. サブディビジョンサーフェスモディファイアで形を滑らかに  
1. ソリッド化モディファイアで厚み付け  

傾いているオブジェクトをモデリングするときは，オブジェクトモードで傾きをつけて編集モードでローカル座標を用いてモデリングするとやりやすい

### 使えると便利なコマンド
`Shift+S`>カーソル→選択物　3Dカーソルを選択中の頂点，オブジェクトの中心に移動させる．
`Shift+S`>選択物→カーソル　選択中の頂点，オブジェクトを3Dカーソルの位置に移動させる．
オブジェクトモードで　オブジェクト>原点を設定>原点を3Dカーソルへ
↑ホイールの中心を探したり，複製したホイールを反対側へ移動させたりするのに便利．

### 3Dモデルのチェック
Blender上では表示されているが，3DCGでは基本的に裏面は描画されない．気づかないうちに面が裏返っているとassettocorsaにもっていったときにパーツが透明になっていたり表示（陰影）がおかしくなってしまう．
####面の向きの確認
ビューポートオーバーレイの設定パネルを開き`面の向き`にチェック  
表面が青，裏面が赤で表示される．面が裏返ってしまっているオブジェクトがあったら，編集モードで選択して`Shift+N`で法線を再計算すると直ることが多い．直らない場合は法線を再計算タブの中の`内側に`にチェック．これでもうまくいかない場合は裏返ってる面を個別に選択して`Alt+N`，`反転`で修正する．


| Back | Next |
|:---:|:---:|
| [3-4 stlファイルをblenderにインポートする](https://github.com/JSAE-ARCHIVES/MOD-Tutorial/blob/main/3%E7%AB%A0%203D%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90/3-4%20stl%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92blender%E3%81%AB%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B.md) | [3-6 テクスチャ作成](https://github.com/JSAE-ARCHIVES/MOD-Tutorial/blob/main/3%E7%AB%A0%203D%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90/3-6%20%E3%83%86%E3%82%AF%E3%82%B9%E3%83%81%E3%83%A3%E4%BD%9C%E6%88%90.md) |












